import{d as t,r as e,V as a,an as s,z as l,c as i,v as n,a4 as o,b as r,e as u,f as c,g as h,w as d,h as v,B as p,A as g,J as f,D as m,C as x,G as y,Z as b,_ as W,X as T,m as k,k as w,F as C,i as S,t as X,j as Y,x as P,I as _}from"./index-Bl407YMq.js";import{_ as M}from"./ht-button.8vkNbh4T.js";import{b as F,n as H,_ as q}from"./base64.CiSqhNY6.js";import{u as L}from"./useTranslate.C8VGrN03.js";const N=q(t({name:"ht-signature",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...F,penColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},clearText:String,revokeText:String,restoreText:String,confirmText:String,fileType:{type:String,default:"png"},quality:{type:Number,default:1},exportScale:{type:Number,default:1},disabled:{type:Boolean,default:!1},height:H,width:H,backgroundColor:String,disableScroll:{type:Boolean,default:!0},enableHistory:{type:Boolean,default:!1},step:{type:Number,default:1},undoText:String,redoText:String,pressure:{type:Boolean,default:!1},minWidth:{type:Number,default:2},maxWidth:{type:Number,default:6},minSpeed:{type:Number,default:1.5}},emits:["start","end","signing","confirm","clear"],setup(t,{expose:F,emit:H}){const q=t,N=H,{translate:D}=L("signature"),{proxy:R}=_(),j=e(`signature${a()}`);let z=null;const B=e(!1),I=e(1),$=s({canvasWidth:0,canvasHeight:0,ctx:null});l((()=>q.penColor),(()=>{ot()})),l((()=>q.lineWidth),(()=>{ot()}));const E=i((()=>{const t={};return f(q.width)&&(t.width=m(q.width)),f(q.height)&&(t.height=m(q.height)),`${x(t)};`})),J=i((()=>q.disableScroll)),G=i((()=>q.enableHistory)),A=e([]),U=e([]),V=e(),Z=e(0);const K=()=>q.pressure?(q.maxWidth+q.minWidth)/2:q.lineWidth,O=t=>{t.preventDefault(),B.value=!0,ot(),N("start",t);const{x:e,y:a}=t.touches[0];V.value={points:[{x:e,y:a,t:Date.now()}],color:q.penColor,width:K(),backgroundColor:q.backgroundColor,isPressure:q.pressure},U.value=[],st(t)},Q=t=>{t.preventDefault(),B.value=!1,V.value&&(A.value.push({...V.value,points:V.value.points.map((t=>({...t,t:t.t,speed:t.speed,distance:t.distance,lineWidth:t.lineWidth,lastX1:t.lastX1,lastY1:t.lastY1,lastX2:t.lastX2,lastY2:t.lastY2,isFirstPoint:t.isFirstPoint})))}),Z.value=A.value.length),V.value=void 0;const{ctx:e}=$;e&&e.beginPath(),N("end",t)},tt=(t=!1)=>{!t&&$.canvasHeight&&$.canvasWidth||new Promise((t=>{const{ctx:e}=$;if(e)return t(e);y(`#${j.value}`,!1,R).then((e=>{var a,s;a=e.width,s=e.height,$.canvasHeight=s*I.value,$.canvasWidth=a*I.value,$.ctx=b(j.value,R),$.ctx&&$.ctx.scale(I.value,I.value),t($.ctx)}))})).then((()=>{const{ctx:t}=$;t&&f(q.backgroundColor)&&(t.setFillStyle(q.backgroundColor),t.fillRect(0,0,$.canvasWidth,$.canvasHeight),t.draw())}))},et=()=>{A.value=[],U.value=[],Z.value=0,function(){const{canvasWidth:t,canvasHeight:e,ctx:a}=$;a&&(a.clearRect(0,0,t,e),f(q.backgroundColor)&&(a.setFillStyle(q.backgroundColor),a.fillRect(0,0,t,e)),a.draw())}(),N("clear")},at=()=>{!function(){const{fileType:t,quality:e,exportScale:a}=q,{canvasWidth:s,canvasHeight:l}=$;W({width:s*a,height:l*a,destWidth:s*a,destHeight:l*a,fileType:t,quality:e,canvasId:j.value,canvas:z,success:t=>{const e={tempFilePath:t.tempFilePath,width:s*a/I.value,height:l*a/I.value,success:!0};N("confirm",e)},fail:()=>{const t={tempFilePath:"",width:s*a/I.value,height:l*a/I.value,success:!1};N("confirm",t)}},R)}()},st=t=>{t.preventDefault();const{ctx:e}=$;if(!B.value||q.disabled||!e)return;const{x:a,y:s}=t.touches[0],l={x:a,y:s,t:Date.now()};if(V.value){const t=V.value.points,i=t[t.length-1];if(i.t===l.t||i.x===a&&i.y===s)return;if(l.distance=Math.sqrt(Math.pow(l.x-i.x,2)+Math.pow(l.y-i.y,2)),l.speed=l.distance/(l.t-i.t||.1),q.pressure&&(l.lineWidth=function(t){if(!q.pressure)return q.lineWidth;const e=q.minSpeed||1.5,a=Math.min(10*e,Math.max(e,t)),s=(q.maxWidth-q.minWidth)*(a-e)/e,l=Math.max(q.maxWidth-s,q.minWidth);return Math.min(l,q.maxWidth)}(l.speed),t.length>=2)){if(t[t.length-2].lineWidth&&i.lineWidth){const t=(l.lineWidth-i.lineWidth)/i.lineWidth,e=.2;if(Math.abs(t)>e){const a=t>0?e:-e;l.lineWidth=i.lineWidth*(1+a)}}}t.push(l),q.pressure?t.length>=2&&function(t,e){const{ctx:a}=$;if(!a)return;const s=e.x-t.x,l=e.y-t.y;if(Math.sqrt(s*s+l*l)<=2)e.lastX1=e.lastX2=t.x+.5*s,e.lastY1=e.lastY2=t.y+.5*l;else{const a=e.speed||0,i=q.minSpeed||1.5,n=Math.max(.1,Math.min(.9,a/(10*i)));e.lastX1=t.x+s*(.2+.3*n),e.lastY1=t.y+l*(.2+.3*n),e.lastX2=t.x+s*(.8-.3*n),e.lastY2=t.y+l*(.8-.3*n)}const i=e.lineWidth||q.lineWidth;"number"==typeof t.lastX1?(a.setLineWidth(i),a.beginPath(),a.moveTo(t.lastX2,t.lastY2),a.quadraticCurveTo(t.x,t.y,e.lastX1,e.lastY1),a.stroke(),t.isFirstPoint||(a.beginPath(),a.moveTo(t.lastX1,t.lastY1),a.quadraticCurveTo(t.x,t.y,t.lastX2,t.lastY2),a.stroke()),a.draw(!0)):e.isFirstPoint=!0}(i,l):(e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(l.x,l.y),e.stroke(),e.draw(!0))}N("signing",t)},lt=()=>{const{ctx:t}=$;t&&(f(q.backgroundColor)?(t.setFillStyle(q.backgroundColor),t.fillRect(0,0,$.canvasWidth,$.canvasHeight)):t.clearRect(0,0,$.canvasWidth,$.canvasHeight),0!==A.value.length?(A.value.forEach((e=>{e.points.length&&(t.setStrokeStyle(e.color),t.setLineJoin("round"),t.setLineCap("round"),e.isPressure&&q.pressure?e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1],i=a.x-l.x,n=a.y-l.y;if(Math.sqrt(i*i+n*n)<=2)a.lastX1=a.lastX2=l.x+.5*i,a.lastY1=a.lastY2=l.y+.5*n;else{const t=a.speed||0,e=q.minSpeed||1.5,s=Math.max(.1,Math.min(.9,t/(10*e)));a.lastX1=l.x+i*(.2+.3*s),a.lastY1=l.y+n*(.2+.3*s),a.lastX2=l.x+i*(.8-.3*s),a.lastY2=l.y+n*(.8-.3*s)}const o=a.lineWidth||e.width;"number"==typeof l.lastX1?(t.setLineWidth(o),t.beginPath(),t.moveTo(l.lastX2,l.lastY2),t.quadraticCurveTo(l.x,l.y,a.lastX1,a.lastY1),t.stroke(),l.isFirstPoint||(t.beginPath(),t.moveTo(l.lastX1,l.lastY1),t.quadraticCurveTo(l.x,l.y,l.lastX2,l.lastY2),t.stroke())):a.isFirstPoint=!0})):(t.setLineWidth(e.width),e.points.forEach(((a,s)=>{if(0===s)return;const l=e.points[s-1];t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(a.x,a.y),t.stroke()}))))})),t.draw()):t.draw())},it=()=>{if(!A.value.length)return;const t=Math.min(q.step,A.value.length),e=A.value.splice(A.value.length-t);U.value.push(...e),Z.value=Math.max(0,Z.value-t),lt()},nt=()=>{if(!U.value.length)return;const t=Math.min(q.step,U.value.length),e=U.value.splice(U.value.length-t);A.value.push(...e),Z.value=Math.min(A.value.length,Z.value+t),lt()};function ot(){const{ctx:t}=$;t&&(t.setLineWidth(K()),t.setStrokeStyle(q.penColor),t.setLineJoin("round"),t.setLineCap("round"))}return n((()=>{tt()})),o((()=>{})),F({init:tt,clear:et,confirm:at,restore:nt,revoke:it}),(t,e)=>{const a=T,s=k,l=r(u("ht-button"),M);return c(),h(s,{class:"ht-signature"},{default:d((()=>[v(s,{class:"ht-signature__content"},{default:d((()=>[v(a,{class:"ht-signature__content-canvas","canvas-id":j.value,style:p(E.value),width:$.canvasWidth,height:$.canvasHeight,id:j.value,"disable-scroll":J.value,onTouchstart:O,onTouchend:Q,onTouchmove:st},null,8,["canvas-id","style","width","height","id","disable-scroll"])])),_:1}),v(s,{class:"ht-signature__footer"},{default:d((()=>[g(t.$slots,"footer",{clear:et,confirm:at,currentStep:Z.value,revoke:it,restore:nt,canUndo:A.value.length>0,canRedo:U.value.length>0,historyList:A.value},(()=>[G.value?(c(),w(C,{key:0},[v(l,{size:"small",plain:"",onClick:it,disabled:A.value.length<=0},{default:d((()=>[S(X(t.revokeText||Y(D)("revokeText")),1)])),_:1},8,["disabled"]),v(l,{size:"small",plain:"",onClick:nt,disabled:U.value.length<=0},{default:d((()=>[S(X(t.restoreText||Y(D)("restoreText")),1)])),_:1},8,["disabled"])],64)):P("",!0),v(l,{size:"small",plain:"",onClick:et},{default:d((()=>[S(X(t.clearText||Y(D)("clearText")),1)])),_:1}),v(l,{size:"small",onClick:at},{default:d((()=>[S(X(t.confirmText||Y(D)("confirmText")),1)])),_:1})]),!0)])),_:3})])),_:3})}}}),[["__scopeId","data-v-cf0fca37"]]);export{N as _};
